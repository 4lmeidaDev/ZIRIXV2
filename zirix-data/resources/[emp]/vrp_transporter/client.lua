-----------------------------------------------------------------------------------------------------------------------------------------
-- VRP
-----------------------------------------------------------------------------------------------------------------------------------------
local Tunnel = module("vrp","lib/Tunnel")
local Proxy = module("vrp","lib/Proxy")
vRP = Proxy.getInterface("vRP")
-----------------------------------------------------------------------------------------------------------------------------------------
-- CONEXÃO
-----------------------------------------------------------------------------------------------------------------------------------------
vSERVER = Tunnel.getInterface("vrp_transporter")
-----------------------------------------------------------------------------------------------------------------------------------------
-- VARIÁVEIS
-----------------------------------------------------------------------------------------------------------------------------------------
local check = 0
local blips = false
local inService = false
local serviceX = 4.61
local serviceY = -656.5
local serviceZ = 33.46
local checkMalote = 0
-----------------------------------------------------------------------------------------------------------------------------------------
-- DELIVERYS
-----------------------------------------------------------------------------------------------------------------------------------------
local deliverys = {
	[1] = { 1,147.59,-1035.76,29.35,158.22 },
	[2] = { 2,145.95,-1035.18,29.35,159.58 },
	[3] = { 21,289.11,-1256.84,29.45,272.09 },
	[4] = { 22,288.85,-1282.36,29.64,268.68 },
	[5] = { 23,-56.95,-1752.06,29.43,46.38 },
	[6] = { 24,-203.75,-861.35,30.27,25.8 },
	[7] = { 25,-254.43,-692.46,33.61,158.32 },
	[8] = { 26,-256.22,-716.01,33.53,67.9 },
	[9] = { 27,-721.08,-415.53,34.99,265.41 },
	[10] = { 28,-846.3,-341.27,38.69,115.1 },
	[11] = { 29,-846.84,-340.21,38.69,115.17 },
	[12] = { 30,-2072.35,-317.25,13.32,262.88 },
	[13] = { 31,228.18,338.4,105.57,158.25 },
	[14] = { 32,380.78,323.41,103.57,161.78 },
	[15] = { 33,-30.19,-723.7,44.23,339.56 },
	[16] = { 34,5.27,-919.86,29.56,249.37 },
	[17] = { 35,24.51,-945.96,29.36,338.97 },
	[18] = { 36,33.19,-1348.25,29.5,177.59 },
	[19] = { 37,295.76,-896.13,29.22,251.01 },
	[20] = { 38,296.47,-894.21,29.24,252.01 },
	[21] = { 39,356.96,173.57,103.07,341.32 },
	[22] = { 40,285.48,143.38,104.18,160.1 },
	[23] = { 41,158.65,234.21,106.63,338.35 },
	[24] = { 42,-165.16,234.78,94.93,90.0 },
	[25] = { 43,-165.16,232.76,94.93,90.11 },
	[26] = { 44,-258.82,-723.35,33.48,71.14 },
	[27] = { 45,-301.69,-830.01,32.42,350.36 },
	[28] = { 46,-303.25,-829.73,32.42,354.01 },
	[29] = { 47,129.2,-1291.15,29.27,297.55 },
	[30] = { 48,-717.69,-915.66,19.22,87.44 },
	[31] = { 49,-660.73,-854.06,24.49,179.16 },
	[32] = { 50,1153.69,-326.77,69.21,98.26 },
	[33] = { 52,-1827.27,784.85,138.31,128.04 },
	[34] = { 53,-2975.02,380.14,15.0,262.69 },
	[35] = { 54,-3040.71,593.1,7.91,284.56 },
	[36] = { 55,-1109.8,-1690.81,4.38,125.01 },
	[37] = { 56,-1315.8,-834.76,16.97,307.4 },
	[38] = { 57,-1314.77,-835.98,16.97,305.52 },
	[39] = { 58,527.35,-160.71,57.1,268.13 },
	[40] = { 59,-1430.16,-211.08,46.51,112.53 },
	[41] = { 60,-1415.95,-212.01,46.51,227.98 },
	[42] = { 61,-1286.26,-213.42,42.45,122.23 },
	[43] = { 62,-1289.29,-226.83,42.45,120.79 },
	[44] = { 63,-1285.61,-224.29,42.45,301.24 },
	[45] = { 64,-1205.03,-326.26,37.84,115.33 },
	[46] = { 65,-1205.72,-324.77,37.86,113.88 },
	[47] = { 66,-1282.54,-210.92,42.45,301.87 },
	[48] = { 67,89.73,2.47,68.31,337.43 },
	[49] = { 68,1077.73,-776.52,58.25,180.02 },
	[50] = { 69,-1305.41,-706.37,25.33,127.89 },
	[51] = { 70,-27.98,-724.52,44.23,338.4 },
	[52] = { 71,-57.68,-92.66,57.78,291.21 },
	[53] = { 72,-866.64,-187.78,37.85,120.99 },
	[54] = { 73,-867.6,-186.1,37.85,117.72 },
	[55] = { 77,112.55,-819.38,31.34,159.55 },
	[56] = { 79,-2956.9,487.66,15.47,176.75 },
	[57] = { 80,-2958.98,487.8,15.47,175.92 },
	[58] = { 81,-596.07,-1161.29,22.33,0.51 },
	[59] = { 82,-594.53,-1161.27,22.33,358.18 },
	[60] = { 83,1138.26,-468.94,66.74,72.73 },
	[61] = { 84,1167.0,-456.08,66.8,341.24 },
	[62] = { 85,236.6,219.66,106.29,289.38 },
	[63] = { 86,236.95,218.7,106.29,290.55 },
	[64] = { 87,237.48,217.82,106.29,292.16 },
	[65] = { 88,237.89,216.91,106.29,291.38 },
	[66] = { 89,238.32,215.98,106.29,289.65 },
	[67] = { 90,129.68,-1291.94,29.27,297.52 },
	[68] = { 91,130.11,-1292.67,29.27,295.5 },
	[69] = { 92,119.07,-883.66,31.13,69.71 },
	[70] = { 93,-1410.34,-98.76,52.43,106.76 },
	[71] = { 94,-1409.76,-100.52,52.39,105.93 },
	[72] = { 95,-1570.11,-546.69,34.96,215.83 },
	[73] = { 96,-1571.04,-547.38,34.96,215.83 },
	[74] = { 97,-821.63,-1081.9,11.14,31.81 },
	[75] = { 98,-537.83,-854.49,29.3,179.26 },
	[76] = { 99,111.31,-775.26,31.44,341.09 },
	[77] = { 100,114.45,-776.39,31.42,340.98 }	
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- MALOTES
-----------------------------------------------------------------------------------------------------------------------------------------
local malotes = {
	[1] = { 263.43,216.33,101.69,337.28 },
	[2] = { 264.68,215.98,101.69,337.28 },
	[3] = { 265.91,215.5,101.69,337.28 },
	[4] = { 266.26,214.65,101.69,251.67 },
	[5] = { 265.85,213.54,101.69,251.67 },
	[6] = { 265.5,212.42,101.69,251.67 },
	[7] = { 264.61,212.08,101.69,158.67 },
	[8] = { 263.3,212.51,101.69,158.67 },
	[9] = { 262.09,212.99,101.69,158.67 }
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- FUNÇÕES
-----------------------------------------------------------------------------------------------------------------------------------------
local hora = 0
function CalculateTimeToDisplay()
	hora = GetClockHours()
	if hora <= 9 then
		hora = "0" .. hora
	end
end
-----------------------------------------------------------------------------------------------------------------------------------------
-- STARTDELIVERY
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		Citizen.Wait(5)
		if not inService then
			local ped = PlayerPedId()
			if not IsPedInAnyVehicle(ped) then
				local x,y,z = table.unpack(GetEntityCoords(ped))
				local distance = Vdist(serviceX,serviceY,serviceZ,x,y,z)
				if distance <= 30.0 then
					DrawMarker(23,serviceX,serviceY,serviceZ-0.97,0,0,0,0,0,0,1.0,1.0,0.5,136, 96, 240, 180,0,0,0,0)
					if distance <= 1.2 then
						drawTexts("PRESSIONE  ~b~E~w~  PARA INICIAR ENTREGAS",4,0.5,0.93,0.50,255,255,255,180)
						if IsControlJustPressed(1,38) then
							CalculateTimeToDisplay()
							if parseInt(hora) >= 06 and parseInt(hora) <= 20 then
								inService = true
								check = math.random(#deliverys)
								checkMalote = math.random(#malotes)
								makeBlipsServices()
							else
								TriggerEvent("Notify","importante","Funcionamento é das <b>06:00</b> as <b>20:00</b>.",8000)
							end
						end
					end
				end
			end
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- LOOPDELIVERYS
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		Citizen.Wait(5)
		if inService then
			local ped = PlayerPedId()
			if not IsPedInAnyVehicle(ped) then
				local x,y,z = table.unpack(GetEntityCoords(ped))
				local distance = Vdist(deliverys[check][2],deliverys[check][3],deliverys[check][4],x,y,z)
				if distance <= 30.0 then
					DrawMarker(21,deliverys[check][2],deliverys[check][3],deliverys[check][4]-0.6,0,0,0,0.0,0,0,0.5,0.5,0.4,136, 96, 240, 180,0,0,0,1)
					if distance <= 1.2 then
						drawTexts("PRESSIONE  ~b~E~w~  PARA ENTREGAR OS MALOTES",4,0.5,0.93,0.50,255,255,255,180)
						if IsControlJustPressed(1,38) and GetEntityModel(GetPlayersLastVehicle()) == 1747439474 then
							CalculateTimeToDisplay()
							if parseInt(hora) >= 06 and parseInt(hora) <= 20 then
								if vSERVER.startPayments(deliverys[check][1]) then
									RemoveBlip(blips)
									check = math.random(#deliverys)
									makeBlipsServices()
								end
							else
								TriggerEvent("Notify","importante","Funcionamento é das <b>06:00</b> as <b>20:00</b>.",8000)
							end
						end
					end
				end
			end
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- LOOPMOLOTES
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		Citizen.Wait(5)
		if inService then
			local ped = PlayerPedId()
			if not IsPedInAnyVehicle(ped) then
				local x,y,z = table.unpack(GetEntityCoords(ped))
				local distance = Vdist(malotes[checkMalote][1],malotes[checkMalote][2],malotes[checkMalote][3],x,y,z)
				if distance <= 30.0 then
					DrawMarker(21,malotes[checkMalote][1],malotes[checkMalote][2],malotes[checkMalote][3]-0.6,0,0,0,0.0,0,0,0.5,0.5,0.4,136, 96, 240, 180,0,0,0,1)
					if distance <= 1.2 then
						drawTexts("PRESSIONE  ~b~E~w~  PARA PEGAR OS MALOTES",4,0.5,0.93,0.50,255,255,255,180)
						if IsControlJustPressed(1,38) and GetEntityModel(GetPlayersLastVehicle()) == 1747439474 then
							CalculateTimeToDisplay()
							if parseInt(hora) >= 06 and parseInt(hora) <= 20 then
								if vSERVER.startMalotes() then
									SetEntityHeading(ped,malotes[checkMalote][4])
									TriggerEvent("cancelando",true)
									vRP._playAnim(false,{"amb@prop_human_parking_meter@female@idle_a","idle_a_female"},true)
									TriggerEvent("Progress",8000)
									SetTimeout(8500,function()
										vRP._stopAnim(false)
										checkMalote = math.random(#malotes)
										TriggerEvent("cancelando",false)
									end)
								end
							else
								TriggerEvent("Notify","importante","Funcionamento é das <b>06:00</b> as <b>20:00</b>.",8000)
							end
						end
					end
				end
			end
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- CANCELSERVICE
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		Citizen.Wait(5)
		if inService and IsControlJustPressed(1,121) then
			inService = false
			RemoveBlip(blips)
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- DRAWTEXTS
-----------------------------------------------------------------------------------------------------------------------------------------
function drawTexts(text,font,x,y,scale,r,g,b,a)
	SetTextFont(font)
	SetTextScale(scale,scale)
	SetTextColour(r,g,b,a)
	SetTextOutline()
	SetTextCentre(1)
	SetTextEntry("STRING")
	AddTextComponentString(text)
	DrawText(x,y)
end
-----------------------------------------------------------------------------------------------------------------------------------------
-- MAKEBLIPSSERVICES
-----------------------------------------------------------------------------------------------------------------------------------------
function makeBlipsServices()
	blips = AddBlipForCoord(deliverys[check][2],deliverys[check][3],deliverys[check][4])
	SetBlipSprite(blips,1)
	SetBlipColour(blips,5)
	SetBlipScale(blips,0.4)
	SetBlipAsShortRange(blips,false)
	SetBlipRoute(blips,true)
	BeginTextCommandSetBlipName("STRING")
	AddTextComponentString("Entregas")
	EndTextCommandSetBlipName(blips)
end